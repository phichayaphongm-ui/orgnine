// ============================================================
// Lotus's Operation Team Org-chart - Code.gs
// Deploy as Web App: Execute as ME, Anyone can access
// ============================================================

const SHEET_ID  = '1A9sHEE0q5LiNq86ro_sll4FPIW2hYmtLTUPSlta5Gj0';
const FOLDER_ID = '1Wwhdu3jKR-AdDP4CZzy4zHvoIUuegon_';
const ORG_SHEET = 'ORG_DATA';
const AGM_SHEET = 'AGM_DATA';
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/edit';

const ORG_HEADERS = [
  'Store ID','Location Code','Store Name Thai','AGM Name',
  'AGM ZONE','Store Name','position','Yr of Service in TL',
  'Service in Position','Mobile Phone','Image URL'
];
const AGM_HEADERS = [
  'AGM Name','AGM ZONE','Mobile Phone','Email','Image URL','Remark'
];

// ── Web App Entry Points ───────────────────────────────────
function doGet(e) {
  const action = (e && e.parameter && e.parameter.action) || 'index';
  let result;

  switch(action) {
    case 'getOrgData':    result = getOrgData(); break;
    case 'getAgmData':    result = getAgmData(); break;
    case 'getSheetUrl':   result = getSheetUrl(); break;
    case 'runSystemTest': result = runSystemTest(); break;
    case 'getImageBase64':
      result = getImageBase64(e.parameter.fileId || '');
      break;
    default:
      // Serve HTML page for browser access
      const tpl = HtmlService.createTemplateFromFile('index');
      return tpl.evaluate()
        .setTitle("Lotus's Operation Team Org-chart")
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
        .addMetaTag('viewport','width=device-width,initial-scale=1');
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const action = (e && e.parameter && e.parameter.action) || '';
  let body = {};
  try { body = JSON.parse(e.postData.contents); } catch(err) {}
  let result;

  switch(action) {
    case 'addRow':       result = addRow(body); break;
    case 'updateRow':    result = updateRow(body.rowIndex, body); break;
    case 'deleteRow':    result = deleteRow(body.rowIndex); break;
    case 'saveAgmRow':   result = saveAgmRow(body); break;
    case 'deleteAgmRow': result = deleteAgmRow(body.agmName); break;
    case 'uploadImage':
      result = uploadImage(body.base64Data, body.filename, body.refId, body.imageType);
      break;
    default:
      result = { success: false, error: 'Unknown action: ' + action };
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// ... (rest of your existing code.gs functions remain the same)
// getOrgData, getAgmData, addRow, updateRow, deleteRow,
// saveAgmRow, deleteAgmRow, uploadImage, getImageBase64, etc.
